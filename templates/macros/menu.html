{% macro menu(config, current_url) %}
    {# https://github.com/ejmg/zerm/blob/669cf19b31bde47276831e307e2087313bd9d5cc/templates/macros/menu.html #}
    {%- if config.extra.main_menu_items and config.extra.main_menu_items | length > 0 %}
        {%- set menu_items = config.extra.main_menu_items -%}
        {%- set main_len = menu_items | length -%}

        {%- if config.extra.main_menu_show -%}
            {%- set show_len = config.extra.main_menu_show -%}
            {%- set menu_more = config.extra.main_menu_more -%}
        {%- else -%}
            {%- set show_len = main_len -%}
            {%- set menu_more = "" -%}
        {%- endif -%}

        <nav class="menu">
            <ul class="menu__inner menu__inner--desktop">
                {{ menu::items(menu=menu_items | slice(end=show_len), current_url=current_url)}}

                {%- if main_len > show_len -%}
                    <ul class="menu__sub-inner">
                        <li class="menu__sub-inner-more-trigger" tabindex="0">{{ menu_more  }} ▾</li>
                        <ul class="menu__sub-inner-more hidden">
                            {{ menu::items(menu=menu_items | slice(start=show_len), current_url=current_url) }}
                        </ul>
                    </ul>
                {%- endif -%}
            </ul>

            <ul class="menu__inner menu__inner--mobile">
                {{ menu::items(menu=menu_items, current_url=current_url) }}
            </ul>
        </nav>
    {% endif -%}
{% endmacro menu %}

{% macro items(menu, current_url) %}
    {# https://github.com/pawroman/zola-theme-terminimal/blob/master/templates/macros/menu.html #}

    {%- for item in menu %}
        {% if item.external %}
            {% continue %}
        {% endif -%}

        {%- set abs_item_url = get_url(path=item.url) -%}
        {%- set is_current = current_url == abs_item_url ~ "/"
                             or current_url == abs_item_url
        -%}
        {%- set is_base = abs_item_url == config.base_url
                              or abs_item_url == config.base_url ~ "/"
        -%}

        {%- if is_base %}
            {%- set_global base_item = item -%}
        {% endif -%}

        {%- if is_current and not is_base %}
            {%- set_global current_item = item -%}
        {% endif -%}
    {% endfor -%}

    {%- if not current_item and base_item %}
        {%- set current_item = base_item -%}
    {% endif -%}

    {%- for item in menu -%}
        <li {%- if current_item and current_item == item %} class="active" {%- endif %}>
            <a href="{{ menu::get_link(item=item) }}" {%- if item.newtab %} target="_blank" rel="noopener noreferrer" {%- endif %}>
                {{ item.name }}{% if item.external %} {%- endif %}
            </a>
        </li>
    {%- endfor -%}
{% endmacro items %}

{% macro get_link(item) %}
    {% if item.external %}
        {{ item.url }}
    {% else %}
        {{ get_url(path=item.url) }}
    {% endif %}
{% endmacro get_link %}
